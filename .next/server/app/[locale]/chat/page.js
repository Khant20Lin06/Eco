(()=>{var e={};e.id=523,e.ids=[523],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4300:e=>{"use strict";e.exports=require("buffer")},2081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},612:e=>{"use strict";e.exports=require("node:os")},7742:e=>{"use strict";e.exports=require("node:process")},5997:e=>{"use strict";e.exports=require("node:tty")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},6238:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>i.a,__next_app__:()=>u,originalPathname:()=>x,pages:()=>c,routeModule:()=>f,tree:()=>o});var r=s(8149),a=s(2658),n=s(9457),i=s.n(n),l=s(9960),d={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>l[e]);s.d(t,d);let o=["",{children:["[locale]",{children:["chat",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,3771)),"C:\\Users\\Admin\\OneDrive\\Desktop\\Project\\eco\\frontend\\src\\app\\[locale]\\chat\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,4208)),"C:\\Users\\Admin\\OneDrive\\Desktop\\Project\\eco\\frontend\\src\\app\\[locale]\\layout.tsx"]}]},{layout:[()=>Promise.resolve().then(s.bind(s,6738)),"C:\\Users\\Admin\\OneDrive\\Desktop\\Project\\eco\\frontend\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,7066,23)),"next/dist/client/components/not-found-error"]}],c=["C:\\Users\\Admin\\OneDrive\\Desktop\\Project\\eco\\frontend\\src\\app\\[locale]\\chat\\page.tsx"],x="/[locale]/chat/page",u={require:s,loadChunk:()=>Promise.resolve()},f=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/[locale]/chat/page",pathname:"/[locale]/chat",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},8885:(e,t,s)=>{Promise.resolve().then(s.bind(s,1657))},1657:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var r=s(241),a=s(1662),n=s(8895),i=s(4045),l=s(2999),d=s(2863);function o({name:e,size:t=36}){return r.jsx("span",{className:`inline-flex shrink-0 items-center justify-center rounded-full bg-gradient-to-br text-xs font-semibold text-white ${function(e){let t=["from-[#4e7bff] to-[#6ea8ff]","from-[#36a39f] to-[#6bd1bd]","from-[#7c58d6] to-[#9a7dff]","from-[#e06b63] to-[#f29d7e]","from-[#3e5d7f] to-[#6287a8]"],s=0;for(let t=0;t<e.length;t+=1)s=(s<<5)-s+e.charCodeAt(t)|0;let r=Math.abs(s)%t.length;return t[r]??t[0]}(e)}`,style:{width:t,height:t},children:function(e){let t=e.trim().split(/\s+/).filter(Boolean);return 0===t.length?"U":1===t.length?(t[0]??"U").slice(0,1).toUpperCase():`${t[0]?.[0]??""}${t[1]?.[0]??""}`.toUpperCase()}(e)})}function c({params:{locale:e}}){let t=(0,n.useSearchParams)().get("orderId")??"",{ready:s,accessToken:c}=(0,l._)(),[x,u]=(0,a.useState)([]),[f,m]=(0,a.useState)(!0),[p,h]=(0,a.useState)(!1),[b,g]=(0,a.useState)(null),[j,y]=(0,a.useState)(t),[v,N]=(0,a.useState)(""),[w,q]=(0,a.useState)(!1),[P,_]=(0,a.useState)(null),[I,S]=(0,a.useState)("You"),{connected:C,messages:k,setMessages:$}=function(e,t){let[s,r]=(0,a.useState)([]),[n,i]=(0,a.useState)({}),[l,o]=(0,a.useState)(!1);(0,a.useEffect)(()=>{if(!e||!t){o(!1);return}let s=(0,d.I)(e),a=()=>{o(!0),s.emit("chat:subscribe",{orderId:t})},n=()=>o(!1),l=e=>{e.orderId===t&&r(t=>t.some(t=>t.id===e.message.id)?t:[...t,e.message])},c=e=>{e.orderId===t&&i(t=>({...t,[e.userId]:{userId:e.userId,lastReadMessageId:e.lastReadMessageId,lastReadAt:e.lastReadAt}}))};return s.on("connect",a),s.on("disconnect",n),s.on("chat:message",l),s.on("chat:read",c),s.connected&&a(),()=>{s.off("connect",a),s.off("disconnect",n),s.off("chat:message",l),s.off("chat:read",c)}},[e,t]);let c=(0,a.useCallback)((s,r)=>{e&&t&&(0,d.I)(e).emit("chat:send",{orderId:t,body:s,clientMessageId:r})},[e,t]),x=(0,a.useCallback)(s=>{e&&t&&(0,d.I)(e).emit("chat:mark-read",{orderId:t,messageId:s})},[e,t]);return{connected:l,messages:s,setMessages:r,readStates:(0,a.useMemo)(()=>Object.values(n),[n]),sendMessage:c,markRead:x}}(c,j);async function A(e,t){let s=(await (0,i.w$)({limit:20},e)).items??[];if(u(s),!s.length){y(t??"");return}let r=t??void 0;y(e=>r||(e&&s.some(t=>t.orderId===e)?e:s[0]?.orderId??""))}async function O(e,t){h(!0);try{let s=[...(await (0,i.$8)(t,{limit:50},e)).items??[]].reverse();$(s);let r=s.at(-1);r&&await (0,i.yb)(t,{messageId:r.id},e),g(null)}catch{g("Failed to load messages."),$([])}finally{h(!1)}}(0,a.useEffect)(()=>{t&&y(t)},[t]),(0,a.useEffect)(()=>{if(!s)return;if(!c){m(!1),g("Please login to open chat.");return}let e=!0;return m(!0),A(c,t).then(()=>{e&&g(null)}).catch(()=>{e&&(t&&y(t),g("Failed to load chat threads."))}).finally(()=>{e&&m(!1)}),()=>{e=!1}},[s,c,t]),(0,a.useEffect)(()=>{if(!c){_(null),S("You");return}let e=!0;return(0,i.ts)(c).then(t=>{var s;e&&(_(t.id),S((s=t.email)?(s.split("@")[0]??"user").replace(/[._-]/g," "):"User"))}).catch(()=>{e&&(_(null),S("You"))}),()=>{e=!1}},[c]),(0,a.useEffect)(()=>{if(!c||!j){$([]);return}O(c,j)},[c,j,$]);let U=(0,a.useMemo)(()=>x.find(e=>e.orderId===j),[x,j]);async function D(){if(c&&j&&v.trim()){q(!0);try{let e=(await (0,i.bE)(j,{body:v.trim()},c)).message;$(t=>t.some(t=>t.id===e.id)?t:[...t,e]),N(""),g(null),await A(c,j)}catch{g("Failed to send message.")}finally{q(!1)}}}async function E(){if(!c||!j||0===k.length)return;let e=k.at(-1);if(e)try{await (0,i.yb)(j,{messageId:e.id},c),await A(c,j),g(null)}catch{g("Failed to update read state.")}}return(0,r.jsxs)("section",{className:"space-y-4",children:[r.jsx("div",{className:"surface p-5 md:p-6",children:(0,r.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[(0,r.jsxs)("div",{children:[r.jsx("h1",{className:"text-2xl font-semibold text-[#181f46]",children:"Order Chat"}),r.jsx("p",{className:"mt-1 text-sm text-[#5d6486]",children:"Chat between customer and vendor owner, thread by order."})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:`chip ${C?"chip-success":"chip-warn"}`,children:C?"Realtime connected":"Realtime offline"}),r.jsx("a",{className:"rounded-lg border border-[#c6d5ff] bg-white px-3 py-1.5 text-xs font-semibold text-[#3349ad]",href:`/${e}/orders`,children:"Back to orders"})]})]})}),b?r.jsx("div",{className:"surface border-[#ffd7dd] bg-[#fff5f6] p-4 text-sm text-[#b12f43]",children:b}):null,(0,r.jsxs)("div",{className:"grid gap-4 lg:grid-cols-[340px_1fr]",children:[(0,r.jsxs)("aside",{className:"surface p-3",children:[r.jsx("h2",{className:"px-2 py-2 text-sm font-semibold uppercase tracking-wide text-[#6070a6]",children:"Threads"}),f?r.jsx("p",{className:"px-2 py-3 text-sm text-[#5d6486]",children:"Loading threads..."}):0===x.length?r.jsx("p",{className:"px-2 py-3 text-sm text-[#5d6486]",children:"No threads yet."}):r.jsx("div",{className:"space-y-2",children:x.map(e=>{let t=e.vendor?.name??`Order ${e.orderId.slice(0,8)}`;return r.jsx("button",{type:"button",onClick:()=>y(e.orderId),className:`w-full rounded-xl border px-3 py-2 text-left transition ${j===e.orderId?"border-[#9db5ff] bg-[#f2f6ff]":"border-[#dbe2ff] bg-white hover:border-[#bfd0ff]"}`,children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[r.jsx(o,{name:t}),(0,r.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[r.jsx("p",{className:"truncate text-sm font-semibold text-[#1b2452]",children:t}),e.unread?r.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-[#3d66ff]"}):null]}),(0,r.jsxs)("p",{className:"mt-0.5 text-[11px] text-[#60709b]",children:["Order #",e.orderId.slice(0,8)]}),r.jsx("p",{className:"mt-1 line-clamp-2 text-xs text-[#5f688f]",children:e.lastMessage?.body??"No message yet."})]})]})},e.id)})})]}),r.jsx("div",{className:"surface flex min-h-[560px] flex-col p-4",children:j?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2 border-b border-[#e1e7ff] pb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[r.jsx(o,{name:U?.vendor?.name??`Order ${j.slice(0,8)}`,size:42}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm font-semibold text-[#1b2452]",children:U?.vendor?.name??"Conversation"}),(0,r.jsxs)("p",{className:"text-xs text-[#60709b]",children:["Order #",j.slice(0,8)," - ",U?.order?.status??"STATUS_UNKNOWN"," -"," ",U?.order?.fulfillment??"ORDER"]})]})]}),r.jsx("button",{className:"rounded-lg border border-[#c6d5ff] bg-white px-3 py-1.5 text-xs font-semibold text-[#3349ad]",type:"button",onClick:E,disabled:0===k.length,children:"Mark read"})]}),r.jsx("div",{className:"flex-1 space-y-3 overflow-y-auto px-1 py-4",children:p?r.jsx("p",{className:"text-sm text-[#5d6486]",children:"Loading messages..."}):0===k.length?r.jsx("p",{className:"text-sm text-[#5d6486]",children:"No messages yet. Start conversation."}):k.map(e=>{let t=!!P&&e.senderUserId===P,s=t?I:U?.vendor?.name??"User";return r.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:(0,r.jsxs)("div",{className:`flex max-w-[84%] items-end gap-2 ${t?"flex-row-reverse":""}`,children:[r.jsx(o,{name:s,size:30}),(0,r.jsxs)("article",{className:`rounded-2xl px-3 py-2 ${t?"bg-[#3654c5] text-white":"border border-[#dbe2ff] bg-[#fbfcff] text-[#1f2858]"}`,children:[r.jsx("p",{className:"text-sm leading-6",children:e.body}),(0,r.jsxs)("p",{className:`mt-1 text-[11px] ${t?"text-white/80":"text-[#7a84ab]"}`,children:[s," - ",new Date(e.createdAt).toLocaleTimeString()]})]})]})},e.id)})}),(0,r.jsxs)("div",{className:"mt-2 border-t border-[#e1e7ff] pt-3",children:[(0,r.jsxs)("div",{className:"flex items-end gap-2 rounded-2xl border border-[#d7e0ff] bg-[#f9fbff] p-2",children:[r.jsx("textarea",{className:"min-h-[74px] flex-1 resize-none rounded-xl border border-[#cad6ff] bg-white px-3 py-2 text-sm outline-none focus:border-[#8ea8ff]",placeholder:"Write a message...",value:v,onChange:e=>N(e.target.value),maxLength:2e3}),r.jsx("button",{className:"btn-primary rounded-xl px-4 py-2 text-sm font-semibold text-white",type:"button",disabled:w||!v.trim(),onClick:D,children:"Send"})]}),(0,r.jsxs)("p",{className:"mt-2 text-right text-[11px] text-[#7680a6]",children:[v.length,"/2000"]})]})]}):r.jsx("div",{className:"grid flex-1 place-items-center text-sm text-[#5d6486]",children:"Select an order thread to start chat."})})]})]})}},3771:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$typeof:()=>n,__esModule:()=>a,default:()=>i});let r=(0,s(3596).createProxy)(String.raw`C:\Users\Admin\OneDrive\Desktop\Project\eco\frontend\src\app\[locale]\chat\page.tsx`),{__esModule:a,$$typeof:n}=r,i=r.default}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[563,851,482,382],()=>s(6238));module.exports=r})();
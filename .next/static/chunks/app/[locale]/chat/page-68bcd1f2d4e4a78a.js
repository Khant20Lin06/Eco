(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[523],{920:function(e,t,s){Promise.resolve().then(s.bind(s,8986))},2207:function(e,t,s){"use strict";s.r(t);var n=s(5373),a={};for(var l in n)"default"!==l&&(a[l]=(function(e){return n[e]}).bind(0,l));s.d(t,a)},8986:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return c}});var n=s(5964),a=s(800),l=s(2207),r=s(3678),d=s(8440),i=s(942);function o(e){let{name:t,size:s=36}=e;return(0,n.jsx)("span",{className:"inline-flex shrink-0 items-center justify-center rounded-full bg-gradient-to-br text-xs font-semibold text-white ".concat(function(e){var t;let s=["from-[#4e7bff] to-[#6ea8ff]","from-[#36a39f] to-[#6bd1bd]","from-[#7c58d6] to-[#9a7dff]","from-[#e06b63] to-[#f29d7e]","from-[#3e5d7f] to-[#6287a8]"],n=0;for(let t=0;t<e.length;t+=1)n=(n<<5)-n+e.charCodeAt(t)|0;let a=Math.abs(n)%s.length;return null!==(t=s[a])&&void 0!==t?t:s[0]}(t)),style:{width:s,height:s},children:function(e){var t,s,n,a,l;let r=e.trim().split(/\s+/).filter(Boolean);return 0===r.length?"U":1===r.length?(null!==(n=r[0])&&void 0!==n?n:"U").slice(0,1).toUpperCase():"".concat(null!==(a=null===(t=r[0])||void 0===t?void 0:t[0])&&void 0!==a?a:"").concat(null!==(l=null===(s=r[1])||void 0===s?void 0:s[0])&&void 0!==l?l:"").toUpperCase()}(t)})}function c(e){var t,s,c,u,f,m,x,h,v;let{params:{locale:p}}=e,b=null!==(f=(0,l.useSearchParams)().get("orderId"))&&void 0!==f?f:"",{ready:g,accessToken:j}=(0,d._)(),[N,y]=(0,a.useState)([]),[w,S]=(0,a.useState)(!0),[I,k]=(0,a.useState)(!1),[C,E]=(0,a.useState)(null),[_,U]=(0,a.useState)(b),[O,R]=(0,a.useState)(""),[L,M]=(0,a.useState)(!1),[A,F]=(0,a.useState)(null),[P,T]=(0,a.useState)("You"),{connected:Y,messages:z,setMessages:B}=function(e,t){let[s,n]=(0,a.useState)([]),[l,r]=(0,a.useState)({}),[d,o]=(0,a.useState)(!1);(0,a.useEffect)(()=>{if(!e||!t){o(!1);return}let s=(0,i.I)(e),a=()=>{o(!0),s.emit("chat:subscribe",{orderId:t})},l=()=>o(!1),d=e=>{e.orderId===t&&n(t=>t.some(t=>t.id===e.message.id)?t:[...t,e.message])},c=e=>{e.orderId===t&&r(t=>({...t,[e.userId]:{userId:e.userId,lastReadMessageId:e.lastReadMessageId,lastReadAt:e.lastReadAt}}))};return s.on("connect",a),s.on("disconnect",l),s.on("chat:message",d),s.on("chat:read",c),s.connected&&a(),()=>{s.off("connect",a),s.off("disconnect",l),s.off("chat:message",d),s.off("chat:read",c)}},[e,t]);let c=(0,a.useCallback)((s,n)=>{e&&t&&(0,i.I)(e).emit("chat:send",{orderId:t,body:s,clientMessageId:n})},[e,t]),u=(0,a.useCallback)(s=>{e&&t&&(0,i.I)(e).emit("chat:mark-read",{orderId:t,messageId:s})},[e,t]);return{connected:d,messages:s,setMessages:n,readStates:(0,a.useMemo)(()=>Object.values(l),[l]),sendMessage:c,markRead:u}}(j,_);async function W(e,t){var s;let n=null!==(s=(await (0,r.w$)({limit:20},e)).items)&&void 0!==s?s:[];if(y(n),!n.length){U(null!=t?t:"");return}let a=null!=t?t:void 0;U(e=>{var t,s;return a||(e&&n.some(t=>t.orderId===e)?e:null!==(s=null===(t=n[0])||void 0===t?void 0:t.orderId)&&void 0!==s?s:"")})}async function D(e,t){k(!0);try{var s;let n=await (0,r.$8)(t,{limit:50},e),a=[...null!==(s=n.items)&&void 0!==s?s:[]].reverse();B(a);let l=a.at(-1);l&&await (0,r.yb)(t,{messageId:l.id},e),E(null)}catch(e){E("Failed to load messages."),B([])}finally{k(!1)}}(0,a.useEffect)(()=>{b&&U(b)},[b]),(0,a.useEffect)(()=>{if(!g)return;if(!j){S(!1),E("Please login to open chat.");return}let e=!0;return S(!0),W(j,b).then(()=>{e&&E(null)}).catch(()=>{e&&(b&&U(b),E("Failed to load chat threads."))}).finally(()=>{e&&S(!1)}),()=>{e=!1}},[g,j,b]),(0,a.useEffect)(()=>{if(!j){F(null),T("You");return}let e=!0;return(0,r.ts)(j).then(t=>{var s,n;e&&(F(t.id),T((s=t.email)?(null!==(n=s.split("@")[0])&&void 0!==n?n:"user").replace(/[._-]/g," "):"User"))}).catch(()=>{e&&(F(null),T("You"))}),()=>{e=!1}},[j]),(0,a.useEffect)(()=>{if(!j||!_){B([]);return}D(j,_)},[j,_,B]);let K=(0,a.useMemo)(()=>N.find(e=>e.orderId===_),[N,_]);async function $(){if(j&&_&&O.trim()){M(!0);try{let e=(await (0,r.bE)(_,{body:O.trim()},j)).message;B(t=>t.some(t=>t.id===e.id)?t:[...t,e]),R(""),E(null),await W(j,_)}catch(e){E("Failed to send message.")}finally{M(!1)}}}async function Q(){if(!j||!_||0===z.length)return;let e=z.at(-1);if(e)try{await (0,r.yb)(_,{messageId:e.id},j),await W(j,_),E(null)}catch(e){E("Failed to update read state.")}}return(0,n.jsxs)("section",{className:"space-y-4",children:[(0,n.jsx)("div",{className:"surface p-5 md:p-6",children:(0,n.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-2xl font-semibold text-[#181f46]",children:"Order Chat"}),(0,n.jsx)("p",{className:"mt-1 text-sm text-[#5d6486]",children:"Chat between customer and vendor owner, thread by order."})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"chip ".concat(Y?"chip-success":"chip-warn"),children:Y?"Realtime connected":"Realtime offline"}),(0,n.jsx)("a",{className:"rounded-lg border border-[#c6d5ff] bg-white px-3 py-1.5 text-xs font-semibold text-[#3349ad]",href:"/".concat(p,"/orders"),children:"Back to orders"})]})]})}),C?(0,n.jsx)("div",{className:"surface border-[#ffd7dd] bg-[#fff5f6] p-4 text-sm text-[#b12f43]",children:C}):null,(0,n.jsxs)("div",{className:"grid gap-4 lg:grid-cols-[340px_1fr]",children:[(0,n.jsxs)("aside",{className:"surface p-3",children:[(0,n.jsx)("h2",{className:"px-2 py-2 text-sm font-semibold uppercase tracking-wide text-[#6070a6]",children:"Threads"}),w?(0,n.jsx)("p",{className:"px-2 py-3 text-sm text-[#5d6486]",children:"Loading threads..."}):0===N.length?(0,n.jsx)("p",{className:"px-2 py-3 text-sm text-[#5d6486]",children:"No threads yet."}):(0,n.jsx)("div",{className:"space-y-2",children:N.map(e=>{var t,s,a,l;let r=null!==(a=null===(t=e.vendor)||void 0===t?void 0:t.name)&&void 0!==a?a:"Order ".concat(e.orderId.slice(0,8));return(0,n.jsx)("button",{type:"button",onClick:()=>U(e.orderId),className:"w-full rounded-xl border px-3 py-2 text-left transition ".concat(_===e.orderId?"border-[#9db5ff] bg-[#f2f6ff]":"border-[#dbe2ff] bg-white hover:border-[#bfd0ff]"),children:(0,n.jsxs)("div",{className:"flex items-start gap-3",children:[(0,n.jsx)(o,{name:r}),(0,n.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,n.jsx)("p",{className:"truncate text-sm font-semibold text-[#1b2452]",children:r}),e.unread?(0,n.jsx)("span",{className:"h-2.5 w-2.5 rounded-full bg-[#3d66ff]"}):null]}),(0,n.jsxs)("p",{className:"mt-0.5 text-[11px] text-[#60709b]",children:["Order #",e.orderId.slice(0,8)]}),(0,n.jsx)("p",{className:"mt-1 line-clamp-2 text-xs text-[#5f688f]",children:null!==(l=null===(s=e.lastMessage)||void 0===s?void 0:s.body)&&void 0!==l?l:"No message yet."})]})]})},e.id)})})]}),(0,n.jsx)("div",{className:"surface flex min-h-[560px] flex-col p-4",children:_?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex items-center justify-between gap-2 border-b border-[#e1e7ff] pb-3",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)(o,{name:null!==(m=null==K?void 0:null===(t=K.vendor)||void 0===t?void 0:t.name)&&void 0!==m?m:"Order ".concat(_.slice(0,8)),size:42}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-semibold text-[#1b2452]",children:null!==(x=null==K?void 0:null===(s=K.vendor)||void 0===s?void 0:s.name)&&void 0!==x?x:"Conversation"}),(0,n.jsxs)("p",{className:"text-xs text-[#60709b]",children:["Order #",_.slice(0,8)," - ",null!==(h=null==K?void 0:null===(c=K.order)||void 0===c?void 0:c.status)&&void 0!==h?h:"STATUS_UNKNOWN"," -"," ",null!==(v=null==K?void 0:null===(u=K.order)||void 0===u?void 0:u.fulfillment)&&void 0!==v?v:"ORDER"]})]})]}),(0,n.jsx)("button",{className:"rounded-lg border border-[#c6d5ff] bg-white px-3 py-1.5 text-xs font-semibold text-[#3349ad]",type:"button",onClick:Q,disabled:0===z.length,children:"Mark read"})]}),(0,n.jsx)("div",{className:"flex-1 space-y-3 overflow-y-auto px-1 py-4",children:I?(0,n.jsx)("p",{className:"text-sm text-[#5d6486]",children:"Loading messages..."}):0===z.length?(0,n.jsx)("p",{className:"text-sm text-[#5d6486]",children:"No messages yet. Start conversation."}):z.map(e=>{var t,s;let a=!!A&&e.senderUserId===A,l=a?P:null!==(s=null==K?void 0:null===(t=K.vendor)||void 0===t?void 0:t.name)&&void 0!==s?s:"User";return(0,n.jsx)("div",{className:"flex ".concat(a?"justify-end":"justify-start"),children:(0,n.jsxs)("div",{className:"flex max-w-[84%] items-end gap-2 ".concat(a?"flex-row-reverse":""),children:[(0,n.jsx)(o,{name:l,size:30}),(0,n.jsxs)("article",{className:"rounded-2xl px-3 py-2 ".concat(a?"bg-[#3654c5] text-white":"border border-[#dbe2ff] bg-[#fbfcff] text-[#1f2858]"),children:[(0,n.jsx)("p",{className:"text-sm leading-6",children:e.body}),(0,n.jsxs)("p",{className:"mt-1 text-[11px] ".concat(a?"text-white/80":"text-[#7a84ab]"),children:[l," - ",new Date(e.createdAt).toLocaleTimeString()]})]})]})},e.id)})}),(0,n.jsxs)("div",{className:"mt-2 border-t border-[#e1e7ff] pt-3",children:[(0,n.jsxs)("div",{className:"flex items-end gap-2 rounded-2xl border border-[#d7e0ff] bg-[#f9fbff] p-2",children:[(0,n.jsx)("textarea",{className:"min-h-[74px] flex-1 resize-none rounded-xl border border-[#cad6ff] bg-white px-3 py-2 text-sm outline-none focus:border-[#8ea8ff]",placeholder:"Write a message...",value:O,onChange:e=>R(e.target.value),maxLength:2e3}),(0,n.jsx)("button",{className:"btn-primary rounded-xl px-4 py-2 text-sm font-semibold text-white",type:"button",disabled:L||!O.trim(),onClick:$,children:"Send"})]}),(0,n.jsxs)("p",{className:"mt-2 text-right text-[11px] text-[#7680a6]",children:[O.length,"/2000"]})]})]}):(0,n.jsx)("div",{className:"grid flex-1 place-items-center text-sm text-[#5d6486]",children:"Select an order thread to start chat."})})]})]})}},8440:function(e,t,s){"use strict";s.d(t,{_:function(){return d}});var n=s(800),a=s(6290),l=s(3178),r=s(2207);function d(){let e=(0,r.usePathname)(),[t,s]=(0,n.useState)(!1),[d,i]=(0,n.useState)(void 0),[o,c]=(0,n.useState)(null),u=()=>{var e;i(null!==(e=(0,a.zf)(l.Qs))&&void 0!==e?e:void 0),c((0,a.ZK)())};return(0,n.useEffect)(()=>{u(),s(!0)},[e]),(0,n.useEffect)(()=>{let e=()=>{u(),s(!0)};return window.addEventListener(l.UY,e),()=>{window.removeEventListener(l.UY,e)}},[]),{ready:t,accessToken:d,role:o}}},942:function(e,t,s){"use strict";s.d(t,{I:function(){return d},p:function(){return i}});var n=s(3651);let a=s(5139).env.NEXT_PUBLIC_WS_URL||"http://localhost:3001/ws",l=null,r=null;function d(e){return l&&r===e?l:(l&&l.disconnect(),r=e,l=(0,n.io)(a,{auth:{token:e},transports:["websocket"],autoConnect:!0,reconnection:!0}))}function i(){l&&(l.disconnect(),l=null,r=null)}}},function(e){e.O(0,[438,320,716,550,744],function(){return e(e.s=920)}),_N_E=e.O()}]);